name: Build & Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  WHISPER_VERSION: "1.7.4"

jobs:
  # JOB 1: Determina a vers√£o e cria a Release
  release:
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git

  # JOB 2: Build Multi-Plataforma
  build:
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            whisper_zip: whisper-v1.7.4-bin-arm64.zip
            whisper_cli: whisper-cli
          - os: ubuntu-latest
            whisper_zip: whisper-v1.7.4-bin-x64.zip
            whisper_cli: whisper-cli
          - os: windows-latest
            whisper_zip: whisper-v1.7.4-bin-x64.zip
            whisper_cli: whisper-cli.exe

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # Linux: Install system dependencies
      - name: Install Linux Dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxtst-dev libxinerama-dev libxkbcommon-dev libxkbcommon-x11-dev libasound2-dev

      # Download pre-built whisper.cpp binary (MUCH faster than compiling)
      - name: Download Whisper Binary
        shell: bash
        run: |
          mkdir -p whisper.cpp/build/bin
          mkdir -p whisper.cpp/models

          # Download pre-built binary
          curl -L -o whisper.zip "https://github.com/ggerganov/whisper.cpp/releases/download/v1.7.4/${{ matrix.whisper_zip }}"
          unzip whisper.zip -d whisper-temp
          cp whisper-temp/${{ matrix.whisper_cli }} whisper.cpp/build/bin/
          chmod +x whisper.cpp/build/bin/${{ matrix.whisper_cli }} || true
          rm -rf whisper.zip whisper-temp

          # Download model
          curl -L -o whisper.cpp/models/ggml-small.bin "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small.bin"

      # --- Electron Build ---

      - name: Install Dependencies
        run: bun install

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install setuptools (for node-gyp)
        run: pip install setuptools

      - name: Rebuild Native Deps
        run: npm rebuild --build-from-source

      - name: Build & Publish Electron App
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: |
          npm exec electron-builder -- --publish always
