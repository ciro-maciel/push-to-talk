name: Build & Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  # JOB 1: Determina a versÃ£o e cria a Release
  release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: application
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          working_directory: application
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git

  # JOB 2: Build Multi-Plataforma
  build:
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: application
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # Sync package.json version with semantic-release
      - name: Update package.json version
        shell: bash
        run: |
          VERSION="${{ needs.release.outputs.new_release_version }}"
          echo "Updating package.json to version $VERSION"
          # Use node to update package.json
          node -e "const pkg = require('./package.json'); pkg.version = '$VERSION'; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');"
          cat package.json | grep version

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # Linux: Install system dependencies
      - name: Install Linux Dependencies
        if: matrix.os == 'ubuntu-latest'
        working-directory: .
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxtst-dev libxinerama-dev libxkbcommon-dev libxkbcommon-x11-dev libxrandr-dev libasound2-dev libxt-dev

      # --- WHISPER.CPP (compile from source on all platforms) ---

      - name: Clone whisper.cpp
        run: git clone --depth 1 https://github.com/ggerganov/whisper.cpp.git

      - name: Build Whisper (macOS/Linux)
        if: matrix.os != 'windows-latest'
        run: |
          cd whisper.cpp
          cmake -B build -DGGML_NATIVE=OFF
          cmake --build build --config Release -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

      - name: Build Whisper (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          cd whisper.cpp
          cmake -B build
          cmake --build build --config Release
          # Copy to expected location
          mkdir -p build/bin
          cp build/bin/Release/whisper-cli.exe build/bin/whisper-cli.exe

      # Download model (all platforms)
      - name: Download Whisper Model
        shell: bash
        run: |
          mkdir -p whisper.cpp/models
          curl -L -o whisper.cpp/models/ggml-base.bin "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin"

      # --- Electron Build ---

      - name: Install Dependencies
        run: bun install

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install setuptools (for node-gyp)
        working-directory: .
        run: pip install setuptools

      - name: Rebuild Native Deps
        run: npm rebuild --build-from-source

      - name: Build & Publish Electron App
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          EP_PRE_RELEASE: false
        run: |
          npm exec electron-builder -- --publish always
